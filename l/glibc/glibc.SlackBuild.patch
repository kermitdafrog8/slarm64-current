--- /mnt/data/shares/linux/slackware/slackware64-current/source/l/glibc/glibc.SlackBuild	2018-08-03 23:01:18.344067714 +0100
+++ glibc.SlackBuild	2018-10-15 16:18:53.397710032 +0100
@@ -95,6 +95,10 @@
     OPTIMIZ="-O3 -fPIC"
     LIBDIRSUFFIX="64"
     ;;
+  aarch64)
+    OPTIMIZ="-O3"
+    LIBDIRSUFFIX="64"
+    ;;
   *)
     OPTIMIZ="-O3"
     LIBDIRSUFFIX=""
@@ -109,6 +113,9 @@
     # This should be i586 for all 32-bit x86 arch:
     TARGET=${TARGET:-i586}
     ;;
+  aarch64)
+    TARGET=${TARGET:-aarch64}
+    ;;
 esac
 
 # Hand off the $ARCH variable to $SLACKWARE_ARCH to avoid confusing glibc:
@@ -130,6 +137,9 @@
 # This function fixes a doinst.sh file for x86_64.
 # With thanks to Fred Emmott.
 fix_doinst() {
+  # ARM uses .so.3:
+  sed -i 's?ld-linux.so.[0-9]?'"$ARMLDLINUXVER"'?g' install/doinst.sh
+
   if [ "x$LIBDIRSUFFIX" = "x" ]; then
     return;
   fi;
@@ -143,6 +153,11 @@
   if [ "$SLACKWARE_ARCH" = "x86_64" ]; then
     sed -i 's#ld-linux.so.2#ld-linux-x86-64.so.2#' install/doinst.sh
   fi
+
+  if [ "$SLACKWARE_ARCH" = "aarch64" ]; then
+    sed -i "/# Install NPTL glibc libraries:/i ( cd lib ; ln -sf ../lib${LIBDIRSUFFIX}/incoming/ld-${VERSION}.so $ARMLDLINUXVER )\n" install/doinst.sh
+    sed -i "/# Now, get rid of the temporary directory/i \\\n( cd lib ; ln -sf ../lib${LIBDIRSUFFIX}/ld-${VERSION}.so $ARMLDLINUXVER )\n" install/doinst.sh
+  fi
 }
 
 # This is a patch function to put all glibc patches in the build script
@@ -155,6 +170,8 @@
   zcat $CWD/glibc.ru_RU.CP1251.diff.gz | patch -p1 --verbose || exit 1
   # Add a C.UTF-8 locale:
   zcat $CWD/glibc-c-utf8-locale.patch.gz | patch -p1 --verbose || exit 1
+  # aarch64 multilib dirs:
+  xzcat $CWD/glibc-2.28-aarch64-multilib-dirs.patch.xz | patch -p1 --verbose || exit 1
 }
 
 # This is going to be the initial $DESTDIR:
@@ -213,6 +230,12 @@
 # Clean up leftover CVS directories:
 find . -type d -name CVS -exec rm -r {} \; 2> /dev/null
 
+# Determine version of ld-linux.so
+case $SLACKWARE_ARCH in
+  arm)     export ARMLDLINUXVER="$( grep -A1 "hard-float ABI" sysdeps/unix/sysv/linux/arm/shlib-versions | egrep "^ld=" | awk -F= '{print $2}' )" ;;
+  aarch64) export ARMLDLINUXVER="$( egrep "^ld=" sysdeps/unix/sysv/linux/aarch64/shlib-versions | grep -v "be" | awk -F= '{print $2}' )" ;;
+esac
+
 # Apply patches; exit if any fail.
 apply_patches
 if [ ! $? = 0 ]; then
@@ -241,6 +264,9 @@
   --with-tls \
   --with-__thread \
   --without-cvs \
+  --enable-multi-arch \
+  libc_cv_rtlddir=/lib${LIBDIRSUFFIX} \
+  libc_cv_slibdir=/lib${LIBDIRSUFFIX} \
   $TARGET-slackware-linux
 
 make $NUMJOBS || make || exit 1
@@ -427,7 +453,7 @@
 # Call the function to fix doinst.sh where $LIBDIRSUFFIX is needed:
 fix_doinst
 # Only scrub the links in /lib{,64} that will be created by ldconfig:
-find lib${LIBDIRSUFFIX} -type l -exec rm {} \;
+find lib{,${LIBDIRSUFFIX}} -type l -exec rm {} \;
 # Build the package:
 makepkg -l y -c n $TMP/glibc-solibs-$VERSION-$SLACKWARE_ARCH-$BUILD.txz
 
@@ -440,7 +466,7 @@
 chown -R root:root etc
 chmod 755 etc/profile.d/*
 # Only scrub the links in /lib{,64} that will be created by ldconfig:
-find lib${LIBDIRSUFFIX} -type l -exec rm {} \;
+find lib{,${LIBDIRSUFFIX}} -type l -exec rm {} \;
 mkdir install
 cp -a $CWD/slack-desc.glibc install/slack-desc
 cp -a $CWD/doinst.sh-glibc install/doinst.sh
@@ -462,3 +488,4 @@
 # Done!
 echo
 echo "glibc packages built in $TMP!"
+
