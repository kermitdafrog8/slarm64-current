--- a/ksh93.SlackBuild	2017-10-15 01:48:41.398749435 +0300
+++ b/ksh93.SlackBuild	2017-10-15 12:06:12.662539226 +0300
@@ -43,6 +43,8 @@
 # but package with our real arch label...
 if [ "$ARCH" = "x86_64" ]; then
   SARCH=i386-64
+elif [ "$ARCH" = "aarch64" ]; then
+  SARCH=aarch64
 else
   SARCH=i386
 fi
@@ -68,7 +70,9 @@
   \( -perm 666 -o -perm 664 -o -perm 600 -o -perm 444 -o -perm 440 -o -perm 400 \) \
   -exec chmod 644 {} \;
 
-/bin/ksh bin/package read || exit 1
+[[ -e /bin/ksh ]] && KSH="/bin/ksh"
+
+$KSH ./bin/package read || exit 1
 
 zcat $CWD/patches/ksh-20070328-builtins.patch.gz | patch -p1 --verbose || exit 1
 zcat $CWD/patches/ksh-20100826-fixregr.patch.gz | patch -p1 --verbose || exit 1
@@ -120,6 +124,7 @@
 zcat $CWD/patches/ksh-20140801-arraylen.patch.gz | patch -p1 --verbose || exit 1
 zcat $CWD/patches/ksh-20120801-diskfull.patch.gz | patch -p1 --verbose || exit 1
 zcat $CWD/patches/ksh-20120801-nohupfork.patch.gz | patch -p1 --verbose || exit 1
+xzcat $CWD/bz1477082.patch.xz | patch -p1 --verbose || exit 1
 
 #/dev/fd test does not work because of mock
 sed -i 's|ls /dev/fd|ls /proc/self/fd|' src/cmd/ksh93/features/options
@@ -130,11 +135,13 @@
 # disable register for debugging
 sed -i 1i"#define register" src/lib/libast/include/ast.h
 
-/bin/ksh ./bin/package
-/bin/ksh ./bin/package make mamake ||:
-/bin/ksh ./bin/package make mamake ||:
+SLKCFLAGS="-O2"
+XTRAFLAGS="-fno-strict-aliasing -Wno-unknown-pragmas -Wno-missing-braces -Wno-unused-result -Wno-return-type -Wno-int-to-pointer-cast -Wno-parentheses -Wno-unused -Wno-unused-but-set-variable -Wno-cpp -P"
+
+export CCFLAGS="$SLKCFLAGS $XTRAFLAGS"
 export CC=gcc
-/bin/ksh ./bin/package make -S || exit 1
+
+$KSH ./bin/package only make 'ast-ksh' SHOPT_COSHELL=0 || exit 1
 
 mkdir -p $PKG/bin
 cp arch/linux.$SARCH/bin/ksh $PKG/bin/ksh.new
@@ -230,4 +237,3 @@
 
 cd $PKG
 /sbin/makepkg -l y -c n /tmp/ksh93-$PKGVER-$ARCH-$BUILD.txz
-
